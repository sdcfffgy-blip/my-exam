<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>è¿‘ç°ä»£å²åˆ·é¢˜ - V5.0 æè‡´æ“æ§ç‰ˆ</title>
    <style>
      :root {
        --primary: #2563eb;
        --primary-light: #eff6ff;
        --success: #10b981;
        --success-bg: #ecfdf5;
        --error: #ef4444;
        --error-bg: #fef2f2;
        --text-main: #1f2937;
        --bg-color: #f3f4f6;
        --sidebar-width: 280px;
        /* å®šä¹‰åº•éƒ¨å®‰å…¨è·ç¦»å˜é‡ */
        --safe-bottom: env(safe-area-inset-bottom, 20px);
      }

      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif;
        background-color: var(--bg-color);
        color: var(--text-main);
        height: 100vh;
        display: flex;
        overflow: hidden;
      }

      /* === ä¾§è¾¹æ  === */
      .sidebar {
        width: var(--sidebar-width);
        background: white;
        border-right: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1000;
      }

      .sidebar-header {
        padding: 20px;
        font-size: 1.1rem;
        font-weight: bold;
        color: var(--primary);
        border-bottom: 1px solid #f3f4f6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: calc(20px + env(safe-area-inset-top));
      }

      .chapter-container {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
      }
      .chap-title {
        font-weight: bold;
        padding: 12px 10px;
        margin-top: 10px;
        color: #111;
        background: #f9fafb;
        border-radius: 8px;
        font-size: 0.9rem;
      }
      .type-item {
        padding: 12px 15px;
        margin: 4px 0;
        border-radius: 8px;
        cursor: pointer;
        color: #4b5563;
        font-size: 0.85rem;
        display: flex;
        justify-content: space-between;
      }
      .type-item.selected {
        background: var(--primary);
        color: white;
      }
      .sidebar-footer {
        padding: 15px;
        border-top: 1px solid #eee;
        background: #f9fafb;
        padding-bottom: calc(15px + var(--safe-bottom));
      }

      .mode-switch {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
        padding: 10px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
      }

      /* === ä¸»åŒºåŸŸ === */
      .main-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        position: relative;
        min-width: 0;
      }

      .mobile-nav {
        display: none;
        height: 56px;
        background: white;
        border-bottom: 1px solid #e5e7eb;
        padding: 0 15px;
        align-items: center;
        justify-content: space-between;
        padding-top: env(safe-area-inset-top);
        z-index: 20;
      }

      /* æ»šåŠ¨åŒºåŸŸ */
      .scroll-content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        /* åº•éƒ¨å¤§å¹…ç•™ç™½ï¼Œç¡®ä¿æœ€åçš„å†…å®¹èƒ½æ»šä¸Šæ¥ï¼Œä¸è¢«æŒ‰é’®æŒ¡ä½ */
        padding-bottom: 180px;
        position: relative;
        /* å¹³æ»‘æ»šåŠ¨ */
        scroll-behavior: smooth;
      }

      .card {
        background: white;
        width: 100%;
        max-width: 800px;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        height: fit-content;
        margin-bottom: 20px;
      }

      .meta-info {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }
      .badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: bold;
        font-size: 11px;
      }
      .badge-chap {
        background: var(--primary-light);
        color: var(--primary);
      }
      .badge-type {
        background: #f3e8ff;
        color: #7e22ce;
      }
      .badge-recite {
        background: #fff7ed;
        color: #c2410c;
        border: 1px solid #ffedd5;
        display: none;
      }
      .res-indicator {
        margin-left: auto;
        font-weight: bold;
        font-size: 14px;
      }

      .q-text {
        font-size: 1.15rem;
        line-height: 1.6;
        margin-bottom: 25px;
        color: #111;
        white-space: pre-wrap;
        font-weight: 500;
      }
      .options-list {
        display: grid;
        gap: 12px;
      }

      .option-item {
        display: flex;
        align-items: flex-start;
        padding: 16px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        cursor: pointer;
        transition: 0.2s;
        background: white;
        -webkit-tap-highlight-color: transparent;
      }
      .option-item.selected {
        border-color: var(--primary);
        background: var(--primary-light);
      }
      .option-item.correct {
        border-color: var(--success);
        background: var(--success-bg);
      }
      .option-item.wrong {
        border-color: var(--error);
        background: var(--error-bg);
      }
      .option-item.recite-correct {
        border-color: var(--success);
        background: var(--success-bg);
        position: relative;
      }
      .option-item.recite-correct::after {
        content: "âœ”";
        position: absolute;
        right: 15px;
        color: var(--success);
        font-weight: bold;
      }

      .opt-label {
        font-size: 1.1rem;
        font-weight: bold;
        width: 30px;
        flex-shrink: 0;
        color: #6b7280;
      }
      .opt-content {
        font-size: 1.05rem;
        line-height: 1.5;
        color: #374151;
      }

      /* === åº•éƒ¨æ  (é‡ç‚¹ä¿®å¤) === */
      .footer-bar {
        background: white;
        border-top: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        padding: 10px 15px;
        /* é€‚é…åº•éƒ¨å®‰å…¨åŒºï¼Œå¹¶é¢å¤–å¢åŠ é«˜åº¦é˜²æ­¢è¯¯è§¦ */
        padding-bottom: calc(20px + var(--safe-bottom));
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        z-index: 500;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.08);
      }

      .btn {
        height: 50px;
        padding: 0 20px;
        border-radius: 25px;
        border: 1px solid #d1d5db;
        background: white;
        cursor: pointer;
        font-weight: 600;
        font-size: 1rem;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }
      .btn:active {
        transform: scale(0.98);
      }
      .btn-primary {
        background: var(--primary);
        color: white;
        border: none;
        flex: 2;
      }
      .btn-outline {
        border: 1px solid var(--primary);
        color: var(--primary);
        background: white;
      }
      .btn-reset {
        border-color: var(--error);
        color: var(--error);
        width: 100%;
        height: 44px;
        border-radius: 8px;
      }

      /* æ“ä½œåŒº */
      #action-area {
        display: flex;
        gap: 10px;
        margin-top: 25px;
        justify-content: center;
        flex-wrap: wrap;
      }
      .analysis-box {
        margin-top: 25px;
        padding: 20px;
        background: #f8fafc;
        border-left: 5px solid var(--primary);
        display: none;
        border-radius: 10px;
      }
      .analysis-box.show {
        display: block;
        animation: fadeIn 0.3s;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* å¼¹çª—æç¤º (Toast) */
      .toast {
        position: fixed;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 16px 28px;
        border-radius: 50px;
        font-size: 16px;
        font-weight: bold;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s;
        z-index: 2000;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }
      .toast.show {
        opacity: 1;
      }

      .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }

      /* å¼€å…³æ ·å¼ */
      .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 26px;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #cbd5e1;
        transition: 0.4s;
        border-radius: 34px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: var(--success);
      }
      input:checked + .slider:before {
        transform: translateX(24px);
      }

      @media (max-width: 768px) {
        .sidebar {
          position: fixed;
          height: 100%;
          transform: translateX(-100%);
        }
        .sidebar.active {
          transform: translateX(0);
        }
        .mobile-nav {
          display: flex;
        }
        .overlay.active {
          display: block;
        }
        .card {
          border-radius: 0;
          box-shadow: none;
          border-bottom: 1px solid #eee;
          padding: 20px;
          min-height: 70vh;
        }
        /* æ‰‹æœºç«¯åº•éƒ¨ç•™ç™½æ›´å¤š */
        .scroll-content {
          padding: 0;
          padding-bottom: 200px;
        }
      }
    </style>
  </head>
  <body>
    <div class="overlay" id="overlay"></div>
    <div class="toast" id="toast">
      <span>ğŸš€</span> <span id="toast-msg">æç¤ºæ¶ˆæ¯</span>
    </div>

    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <span>ç« èŠ‚ç›®å½•</span>
        <button
          onclick="toggleSidebar()"
          id="close-sidebar"
          style="display: none; background: none; border: none; font-size: 24px"
        >
          Ã—
        </button>
      </div>
      <div class="chapter-container" id="chap-list"></div>
      <div class="sidebar-footer">
        <div class="mode-switch">
          <span style="font-size: 14px; font-weight: bold; color: #4b5563"
            >ğŸ“– èƒŒè¯µæ¨¡å¼</span
          >
          <label class="switch">
            <input
              type="checkbox"
              id="recite-toggle"
              onchange="toggleReciteMode()"
            />
            <span class="slider"></span>
          </label>
        </div>
        <button class="btn btn-reset" onclick="resetCurrentChapter()">
          ğŸ”„ é‡ç½®å½“å‰ç« èŠ‚è®°å½•
        </button>
      </div>
    </div>

    <div class="main-area">
      <div class="mobile-nav">
        <button
          onclick="toggleSidebar()"
          class="btn"
          style="height: 36px; padding: 0 12px; flex: none"
        >
          â˜° ç›®å½•
        </button>
        <span
          id="mobile-title"
          style="font-size: 16px; font-weight: bold; color: var(--primary)"
          >åˆ·é¢˜æ¨¡å¼</span
        >
      </div>

      <div class="scroll-content" id="touch-zone">
        <div class="card">
          <div class="meta-info">
            <span class="badge badge-chap" id="q-chap">è½½å…¥ä¸­</span>
            <span class="badge badge-type" id="q-type">è½½å…¥ä¸­</span>
            <span class="badge badge-recite" id="recite-badge">èƒŒè¯µä¸­</span>
            <span id="res-status" class="res-indicator"></span>
          </div>
          <div class="q-text" id="q-content">æ­£åœ¨è½½å…¥æ•°æ®...</div>
          <div class="options-list" id="options-area"></div>
          <div id="action-area"></div>
          <div class="analysis-box" id="analysis">
            <h4 style="margin: 0 0 10px 0; color: var(--success)">
              æ­£ç¡®ç­”æ¡ˆï¼š<span id="true-ans"></span>
            </h4>
            <div
              id="explanation"
              style="line-height: 1.6; font-size: 15px; color: #4b5563"
            ></div>
          </div>

          <div
            style="
              text-align: center;
              color: #9ca3af;
              font-size: 13px;
              margin-top: 50px;
              opacity: 0.6;
              padding: 20px;
              border-top: 1px dashed #eee;
            "
          >
            <div>ğŸ‘‰ å³æ»‘ä¸‹ä¸€é¢˜ &nbsp;|&nbsp; ğŸ‘ˆ å·¦æ»‘ä¸Šä¸€é¢˜</div>
            <div style="margin-top: 8px">â¬†ï¸ è§¦åº•ä¸Šæ‹‰(x2) ä¸‹ä¸€é¢˜</div>
            <div style="margin-top: 4px">â¬‡ï¸ è§¦é¡¶ä¸‹æ‹‰(x2) ä¸Šä¸€é¢˜</div>
          </div>
        </div>
      </div>

      <div class="footer-bar">
        <button class="btn" onclick="changeQ(-1)">ä¸Šä¸€é¢˜</button>
        <span
          id="progress-txt"
          style="
            font-size: 14px;
            color: #6b7280;
            min-width: 60px;
            text-align: center;
            font-family: monospace;
          "
          >0/0</span
        >
        <button class="btn" onclick="changeQ(1)">ä¸‹ä¸€é¢˜</button>
      </div>
    </div>

    <script>
      let allData = [],
        currentList = [],
        currentChapterName = "";
      let currentIndex = 0,
        userSel = new Set(),
        answered = false;
      let isReciteMode = false;

      // æ‰‹åŠ¿ç›¸å…³å˜é‡
      let startX = 0,
        startY = 0;
      let borderSwipeTimer = null;
      let borderSwipeCountTop = 0;
      let borderSwipeCountBottom = 0;

      window.onload = () => {
        fetch("questions.json")
          .then((res) => res.json())
          .then((data) => {
            allData = data.map((q, i) => ({
              ...q,
              id: i,
              historySel: [],
              isSubmitted: false,
            }));
            initSidebar();
            if (window.innerWidth <= 768)
              document.getElementById("close-sidebar").style.display = "block";
            const first = document.querySelector(".type-item");
            if (first) first.click();
            initGestures();
          })
          .catch((err) => {
            document.getElementById("q-content").innerText =
              "åŠ è½½å¤±è´¥ã€‚è¯·ç¡®ä¿ questions.json ä¸ HTML å¤„äºåŒä¸€ç›®å½•ã€‚";
          });
      };

      function initGestures() {
        const zone = document.getElementById("touch-zone");

        zone.addEventListener(
          "touchstart",
          (e) => {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
          },
          { passive: true }
        );

        zone.addEventListener(
          "touchend",
          (e) => {
            const endX = e.changedTouches[0].clientX;
            const endY = e.changedTouches[0].clientY;
            const diffX = endX - startX;
            const diffY = endY - startY;

            // 1. å·¦å³æ»‘åŠ¨ (æ°´å¹³ä½ç§» > 60px ä¸” æ°´å¹³ä½ç§» > å‚ç›´ä½ç§»çš„1.5å€)
            if (
              Math.abs(diffX) > 60 &&
              Math.abs(diffX) > Math.abs(diffY) * 1.5
            ) {
              // diffX > 0 (å‘å³æ»‘) -> ä¸‹ä¸€é¢˜ (æŒ‰æ‚¨è¦æ±‚å®šåˆ¶)
              // diffX < 0 (å‘å·¦æ»‘) -> ä¸Šä¸€é¢˜
              if (diffX > 0) changeQ(1);
              else changeQ(-1);
              return;
            }

            // 2. å‚ç›´è¾¹ç¼˜è¿æ»‘ (è§¦é¡¶/è§¦åº•)
            const scrollTop = zone.scrollTop;
            const scrollH = zone.scrollHeight;
            const clientH = zone.clientHeight;

            // åœ¨é¡¶éƒ¨ç»§ç»­ä¸‹æ‹‰ (ä¸Šä¸€é¢˜)
            if (scrollTop <= 5 && diffY > 60) {
              handleBorderSwipe("top");
            }
            // åœ¨åº•éƒ¨ç»§ç»­ä¸Šæ‹‰ (ä¸‹ä¸€é¢˜) - å¢åŠ å®¹å·®å€¼
            else if (scrollTop + clientH >= scrollH - 10 && diffY < -60) {
              handleBorderSwipe("bottom");
            }
          },
          { passive: true }
        );
      }

      function handleBorderSwipe(dir) {
        const now = Date.now();
        // 2ç§’å†…æœ‰æ•ˆ
        if (now - borderSwipeTimer > 2000) {
          borderSwipeCountTop = 0;
          borderSwipeCountBottom = 0;
        }
        borderSwipeTimer = now;

        if (dir === "top") {
          borderSwipeCountTop++;
          if (borderSwipeCountTop === 1) showToast("â¬‡ï¸ å†æ‹‰ä¸€æ¬¡è·³è½¬ä¸Šä¸€é¢˜");
          else if (borderSwipeCountTop >= 2) {
            changeQ(-1);
            borderSwipeCountTop = 0;
          }
        } else {
          borderSwipeCountBottom++;
          if (borderSwipeCountBottom === 1) showToast("â¬†ï¸ å†æ‹‰ä¸€æ¬¡è·³è½¬ä¸‹ä¸€é¢˜");
          else if (borderSwipeCountBottom >= 2) {
            changeQ(1);
            borderSwipeCountBottom = 0;
          }
        }
      }

      function showToast(msg) {
        const t = document.getElementById("toast");
        document.getElementById("toast-msg").innerText = msg;
        t.classList.add("show");
        setTimeout(() => t.classList.remove("show"), 1500);
      }

      function toggleSidebar() {
        document.getElementById("sidebar").classList.toggle("active");
        document.getElementById("overlay").classList.toggle("active");
      }
      document.getElementById("overlay").onclick = toggleSidebar;

      function toggleReciteMode() {
        isReciteMode = document.getElementById("recite-toggle").checked;
        document.getElementById("recite-badge").style.display = isReciteMode
          ? "inline-block"
          : "none";
        renderQ();
      }

      function initSidebar() {
        const container = document.getElementById("chap-list");
        const chaps = [...new Set(allData.map((q) => q.chapter))].sort(
          (a, b) => parseInt(a.match(/\d+/)) - parseInt(b.match(/\d+/))
        );
        chaps.forEach((chap) => {
          const title = document.createElement("div");
          title.className = "chap-title";
          title.innerText = chap;
          container.appendChild(title);
          const chapQs = allData.filter((q) => q.chapter === chap);
          const types = [...new Set(chapQs.map((q) => q.type))];
          types.forEach((type) => {
            const count = chapQs.filter((q) => q.type === type).length;
            const item = document.createElement("div");
            item.className = "type-item";
            item.innerHTML = `<span>${type}</span> <span style="opacity:0.5">${count}</span>`;
            item.onclick = () => {
              document
                .querySelectorAll(".type-item")
                .forEach((i) => i.classList.remove("selected"));
              item.classList.add("selected");
              if (window.innerWidth <= 768) toggleSidebar();
              currentChapterName = chap;
              currentList = allData.filter(
                (q) => q.chapter === chap && q.type === type
              );
              currentIndex = 0;
              renderQ();
            };
            container.appendChild(item);
          });
        });
      }

      function renderQ() {
        const q = currentList[currentIndex];
        userSel = new Set(q.historySel || []);
        answered = q.isSubmitted || false;

        document.getElementById("q-chap").innerText = q.chapter;
        document.getElementById("q-type").innerText = q.type;
        document.getElementById("progress-txt").innerText = `${
          currentIndex + 1
        }/${currentList.length}`;
        document.getElementById("q-content").innerText = q.content;
        document.getElementById("true-ans").innerText = q.answer;
        document.getElementById("explanation").innerText =
          q.explanation || "æš‚æ— è§£æ";
        document.getElementById("res-status").innerText = "";
        document.getElementById("analysis").classList.remove("show");

        const optArea = document.getElementById("options-area");
        const actArea = document.getElementById("action-area");
        optArea.innerHTML = "";
        actArea.innerHTML = "";
        const correctStr = q.answer.replace(/[^A-D]/g, "");

        if (q.type.includes("é€‰")) {
          q.options.forEach((opt) => {
            const el = document.createElement("div");
            let className = "option-item";
            if (isReciteMode && correctStr.includes(opt.label))
              className += " recite-correct";
            else if (!isReciteMode && userSel.has(opt.label))
              className += " selected";

            el.className = className;
            el.dataset.label = opt.label;
            el.innerHTML = `<div class="opt-label">${opt.label}</div><div class="opt-content">${opt.text}</div>`;
            if (!isReciteMode) el.onclick = () => handleOptClick(el, opt.label);
            optArea.appendChild(el);
          });
          if (!isReciteMode) {
            if (q.type === "å¤šé€‰é¢˜") {
              actArea.innerHTML = `<button class="btn btn-outline" onclick="toggleAns(this)">ğŸ¤” å·çœ‹ç­”æ¡ˆ</button> <button class="btn btn-primary" onclick="submitMulti()">ç¡®è®¤æäº¤</button>`;
            } else {
              actArea.innerHTML = `<button class="btn btn-outline" onclick="toggleAns(this)" style="width:100%">ğŸ¤” å·çœ‹ç­”æ¡ˆ</button>`;
            }
          }
        } else {
          actArea.innerHTML = `<button class="btn btn-primary" onclick="toggleAns(this)" style="width:100%">${
            isReciteMode ? "ğŸ™ˆ éšè—ç­”æ¡ˆ" : "ğŸ‘ï¸ æŸ¥çœ‹ç­”æ¡ˆ"
          }</button>`;
        }

        if (isReciteMode || answered) {
          if (!isReciteMode)
            checkAns(Array.from(userSel).sort().join(""), false);
          document.getElementById("analysis").classList.add("show");
        }
        // åˆ‡æ¢æ—¶é‡ç½®æ»‘åŠ¨è®¡æ•°
        borderSwipeCountTop = 0;
        borderSwipeCountBottom = 0;
        // åˆ‡æ¢é¢˜ç›®æ—¶è‡ªåŠ¨å›é¡¶
        document.getElementById("touch-zone").scrollTop = 0;
      }

      function toggleAns(btn) {
        const box = document.getElementById("analysis");
        if (box.classList.contains("show")) {
          box.classList.remove("show");
          btn.innerText =
            currentList[currentIndex].type.includes("é€‰") && !answered
              ? "ğŸ¤” å·çœ‹ç­”æ¡ˆ"
              : "ğŸ‘ï¸ æŸ¥çœ‹ç­”æ¡ˆ";
        } else {
          box.classList.add("show");
          btn.innerText = "ğŸ™ˆ éšè—ç­”æ¡ˆ";
        }
      }

      function handleOptClick(el, label) {
        const q = currentList[currentIndex];
        if (answered && q.type !== "å¤šé€‰é¢˜") return;
        if (q.type === "å•é€‰é¢˜") {
          checkAns(label, true);
        } else {
          if (userSel.has(label)) {
            userSel.delete(label);
            el.classList.remove("selected");
          } else {
            userSel.add(label);
            el.classList.add("selected");
          }
        }
      }

      function submitMulti() {
        if (answered) return;
        const userAns = Array.from(userSel).sort().join("");
        if (!userAns) return alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé€‰é¡¹");
        checkAns(userAns, true);
      }

      function checkAns(userAns, shouldSave) {
        const q = currentList[currentIndex];
        const correctStr = q.answer
          .replace(/[^A-D]/g, "")
          .split("")
          .sort()
          .join("");
        if (shouldSave) {
          answered = true;
          q.isSubmitted = true;
          q.historySel = Array.from(userSel);
        }
        const status = document.getElementById("res-status");
        if (userAns === correctStr) {
          status.innerText = "âœ“ æ­£ç¡®";
          status.style.color = "var(--success)";
        } else if (userAns !== "") {
          status.innerText = "âœ• é”™è¯¯";
          status.style.color = "var(--error)";
        }
        document.getElementById("analysis").classList.add("show");
        document.querySelectorAll(".option-item").forEach((el) => {
          const lbl = el.dataset.label;
          el.classList.remove("selected");
          if (correctStr.includes(lbl)) el.classList.add("correct");
          else if (userAns.includes(lbl)) el.classList.add("wrong");
        });
      }

      function resetCurrentChapter() {
        if (!currentChapterName) return;
        if (confirm(`ç¡®å®šè¦æ¸…ç©ºâ€œ${currentChapterName}â€çš„æ‰€æœ‰åšé¢˜è®°å½•å—ï¼Ÿ`)) {
          allData.forEach((q) => {
            if (q.chapter === currentChapterName) {
              q.historySel = [];
              q.isSubmitted = false;
            }
          });
          renderQ();
        }
      }

      function changeQ(dir) {
        const next = currentIndex + dir;
        if (next >= 0 && next < currentList.length) {
          currentIndex = next;
          renderQ();
        } else {
          showToast(dir > 0 ? "å·²ç»æ˜¯æœ€åä¸€é¢˜äº†" : "å·²ç»æ˜¯ç¬¬ä¸€é¢˜äº†");
        }
      }
    </script>
  </body>
</html>
