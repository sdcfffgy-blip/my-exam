<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>è¿‘ç°ä»£å² - æ™ºèƒ½å¤ä¹ ç³»ç»Ÿ V12.0</title>
    <style>
      :root {
        --primary: #4f46e5;
        --primary-light: #eef2ff;
        --success: #10b981;
        --warning: #f59e0b;
        --error: #ef4444;
        --text-main: #1f2937;
        --bg-color: #f8fafc;
        --sidebar-width: 280px;
        --safe-bottom: env(safe-area-inset-bottom, 20px);
      }

      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, "PingFang SC", sans-serif;
        background-color: var(--bg-color);
        color: var(--text-main);
        height: 100vh;
        display: flex;
        overflow: hidden;
      }

      /* === ä¾§è¾¹æ  === */
      .sidebar {
        width: var(--sidebar-width);
        background: white;
        border-right: 1px solid #e2e8f0;
        display: flex;
        flex-direction: column;
        z-index: 50;
        transition: transform 0.3s;
        flex-shrink: 0;
      }

      .sidebar-header {
        padding: 20px;
        background: white;
        border-bottom: 1px solid #f1f5f9;
      }

      .app-brand {
        font-size: 1.2rem;
        font-weight: 800;
        color: var(--primary);
        text-align: center;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .mod-tabs {
        display: flex;
        background: #f1f5f9;
        padding: 4px;
        border-radius: 8px;
      }
      .mod-tab {
        flex: 1;
        border: none;
        background: none;
        padding: 8px;
        font-size: 0.85rem;
        font-weight: 600;
        color: #64748b;
        cursor: pointer;
        border-radius: 6px;
        transition: 0.2s;
      }
      .mod-tab.active {
        background: white;
        color: var(--primary);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      .chapter-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
      }

      .chapter-item {
        padding: 12px;
        margin-bottom: 6px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #475569;
        transition: 0.2s;
        border: 1px solid transparent;
      }
      .chapter-item:hover {
        background: var(--primary-light);
      }
      .chapter-item.active {
        background: var(--primary-light);
        color: var(--primary);
        border-color: #c7d2fe;
        font-weight: 600;
      }

      .badge-pill {
        font-size: 0.7rem;
        padding: 2px 8px;
        border-radius: 10px;
        background: #e2e8f0;
        color: #64748b;
      }
      .chapter-item.active .badge-pill {
        background: white;
        color: var(--primary);
      }

      /* === ä¸»å†…å®¹åŒº === */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: 100%;
        background: var(--bg-color);
        position: relative;
        min-width: 0;
      }

      /* é¡¶éƒ¨å¯¼èˆª */
      .top-nav {
        background: white;
        padding: 10px 15px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 20;
      }

      .nav-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .menu-toggle {
        font-size: 1.5rem;
        background: none;
        border: none;
        color: #475569;
        cursor: pointer;
        display: none;
        margin-right: 10px;
      }

      .nav-title {
        font-weight: 700;
        font-size: 1rem;
        color: #0f172a;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
      }

      .jump-box {
        padding: 4px 8px;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        font-size: 0.85rem;
        color: #475569;
        outline: none;
        background: white;
        max-width: 100px;
      }

      /* ç­›é€‰å™¨ */
      .filter-scroll {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding-bottom: 2px;
        scrollbar-width: none; /* Firefox */
      }
      .filter-scroll::-webkit-scrollbar {
        display: none; /* Chrome/Safari */
      }

      .filter-chip {
        padding: 5px 12px;
        border-radius: 20px;
        background: white;
        border: 1px solid #e2e8f0;
        color: #64748b;
        font-size: 0.8rem;
        white-space: nowrap;
        cursor: pointer;
        transition: 0.2s;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .filter-chip:hover {
        border-color: #cbd5e1;
      }
      .filter-chip.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
        box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2);
      }

      /* å†…å®¹æ»šåŠ¨åŒº */
      .content-area {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        justify-content: center;
      }

      .card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        padding: 25px;
        width: 100%;
        max-width: 800px;
        height: fit-content;
        margin-bottom: 20px;
        position: relative;
        overflow: hidden;
      }

      /* çŸ¥è¯†ç‚¹å¡ç‰‡ç‰¹æ®Šæ ·å¼ */
      .card.knowledge-mode {
        border-left: 5px solid var(--warning);
        background: #fffbeb;
      }
      .card.knowledge-mode .q-type {
        background: var(--warning);
        color: white;
      }

      /* ææ–™é¢˜ç‰¹æ®Šæ ·å¼ */
      .card.material-mode {
        border-left: 5px solid #8b5cf6;
      }

      .q-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        align-items: center;
      }

      .q-type {
        font-size: 0.75rem;
        padding: 3px 8px;
        border-radius: 6px;
        font-weight: 700;
        background: #f1f5f9;
        color: #64748b;
        letter-spacing: 0.5px;
      }

      .q-content {
        font-size: 1.15rem;
        line-height: 1.7;
        color: #1e293b;
        margin-bottom: 25px;
        white-space: pre-wrap;
      }

      /* é€‰é¡¹ */
      .opts-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .opt-row {
        display: flex;
        padding: 15px;
        border: 2px solid #f1f5f9;
        border-radius: 12px;
        cursor: pointer;
        background: white;
        transition: 0.15s;
        align-items: flex-start;
      }
      .opt-row:hover {
        border-color: #cbd5e1;
      }
      .opt-row.selected {
        border-color: var(--primary);
        background: var(--primary-light);
      }
      .opt-row.correct {
        border-color: var(--success);
        background: var(--success-bg);
      }
      .opt-row.wrong {
        border-color: var(--error);
        background: var(--error-bg);
      }

      .opt-idx {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: #f1f5f9;
        color: #64748b;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.9rem;
        margin-right: 12px;
        flex-shrink: 0;
      }
      .opt-row.selected .opt-idx {
        background: var(--primary);
        color: white;
      }
      .opt-row.correct .opt-idx {
        background: var(--success);
        color: white;
      }
      .opt-row.wrong .opt-idx {
        background: var(--error);
        color: white;
      }

      /* ç­”æ¡ˆä¸è§£æ */
      .answer-section {
        margin-top: 25px;
        padding: 20px;
        background: #f8fafc;
        border-radius: 12px;
        display: none;
        border: 1px solid #e2e8f0;
      }
      .answer-section.show {
        display: block;
        animation: slideDown 0.3s;
      }

      /* åº•éƒ¨æ“ä½œæ  */
      .action-bar {
        background: white;
        border-top: 1px solid #e2e8f0;
        padding: 12px 20px;
        padding-bottom: max(12px, var(--safe-bottom));
        display: flex;
        gap: 15px;
        align-items: center;
      }

      .btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
      }
      .btn:active {
        transform: scale(0.98);
      }
      .btn-secondary {
        background: #f1f5f9;
        color: #475569;
      }
      .btn-primary {
        background: var(--primary);
        color: white;
        flex: 2;
        box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2);
      }
      .btn-knowledge {
        background: var(--warning);
        color: white;
        flex: 2;
        box-shadow: 0 4px 10px rgba(245, 158, 11, 0.2);
      }

      .tool-row {
        display: flex;
        justify-content: space-between;
        padding: 5px 20px;
      }
      .text-link {
        font-size: 0.85rem;
        color: #64748b;
        cursor: pointer;
        text-decoration: underline;
        background: none;
        border: none;
      }

      /* é®ç½© */
      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 45;
        display: none;
      }

      @media (max-width: 768px) {
        .sidebar {
          position: fixed;
          left: -100%;
          height: 100%;
          width: 85%;
          box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
        }
        .sidebar.open {
          left: 0;
        }
        .menu-toggle {
          display: block;
        }
        .overlay.active {
          display: block;
        }
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="app-brand">âš¡ï¸ å†å²å¤ä¹ ç³»ç»Ÿ</div>
        <div class="mod-tabs">
          <button
            class="mod-tab active"
            onclick="switchModule('postgrad')"
            id="tab-pg"
          >
            ğŸ“š è€ƒç ”çœŸé¢˜
          </button>
          <button
            class="mod-tab"
            onclick="switchModule('history')"
            id="tab-hist"
          >
            ğŸ“ è¯¾åç»ƒä¹ 
          </button>
        </div>
      </div>
      <div class="chapter-list" id="chapterList"></div>
      <div
        style="padding: 15px; text-align: center; border-top: 1px solid #f1f5f9"
      >
        <button
          onclick="resetChapter()"
          style="
            color: #ef4444;
            background: white;
            border: 1px solid #fee2e2;
            padding: 6px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
          "
        >
          ğŸ—‘ï¸ æ¸…ç©ºæœ¬ç« è®°å½•
        </button>
      </div>
    </div>
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <!-- ä¸»ç•Œé¢ -->
    <div class="main-content">
      <div class="top-nav">
        <div class="nav-row">
          <div style="display: flex; align-items: center; overflow: hidden">
            <button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>
            <div class="nav-title" id="headerTitle">è¯·é€‰æ‹©ç« èŠ‚</div>
          </div>
          <select
            class="jump-box"
            id="qJumper"
            onchange="jumpTo(this.value)"
            disabled
          >
            <option>ç¬¬ 0/0 é¢˜</option>
          </select>
        </div>

        <div class="filter-scroll" id="filterBar">
          <button class="filter-chip active" onclick="setFilter('all')">
            â™¾ï¸ å…¨éƒ¨
          </button>
          <button class="filter-chip" onclick="setFilter('çŸ¥è¯†ç‚¹')">
            ğŸ’¡ çŸ¥è¯†ç‚¹
          </button>
          <button class="filter-chip" onclick="setFilter('å•é€‰')">
            ğŸ”´ å•é€‰é¢˜
          </button>
          <button class="filter-chip" onclick="setFilter('å¤šé€‰')">
            ğŸ”µ å¤šé€‰é¢˜
          </button>
          <button class="filter-chip" onclick="setFilter('ç®€ç­”')">
            ğŸŸ¢ ç®€ç­”é¢˜
          </button>
          <button class="filter-chip" onclick="setFilter('ææ–™')">
            ğŸ“œ ææ–™é¢˜
          </button>
        </div>
      </div>

      <div class="content-area" id="qContainer">
        <div style="text-align: center; margin-top: 100px; color: #94a3b8">
          <div style="font-size: 3rem; margin-bottom: 10px">ğŸ‘ˆ</div>
          è¯·åœ¨å·¦ä¾§ç›®å½•é€‰æ‹©ç« èŠ‚å¼€å§‹å¤ä¹ 
        </div>
      </div>

      <div class="tool-row">
        <button class="text-link" onclick="toggleAns()">
          ğŸ‘ï¸ æ˜¾ç¤º/éšè—ç­”æ¡ˆ
        </button>
        <span id="scoreText" style="font-size: 0.85rem; color: #64748b"></span>
      </div>

      <div class="action-bar">
        <button class="btn btn-secondary" onclick="move(-1)">â¬…ï¸ ä¸Šä¸€é¢˜</button>
        <button
          class="btn btn-primary"
          id="mainBtn"
          onclick="handleMainAction()"
        >
          âœ… æäº¤ç­”æ¡ˆ
        </button>
        <button class="btn btn-secondary" onclick="move(1)">ä¸‹ä¸€é¢˜ â¡ï¸</button>
      </div>
    </div>

    <script>
      // === é…ç½®ä¸çŠ¶æ€ ===
      const modules = {
        postgrad: { name: "è€ƒç ”çœŸé¢˜", data: [], prefix: "pg_" },
        history: { name: "è¯¾åç»ƒä¹ ", data: [], prefix: "hist_" },
      };

      let curMod = localStorage.getItem("last_mod") || "postgrad";
      let allData = [];
      let curChapter = "";
      let rawList = []; // ç« èŠ‚å…¨éƒ¨é¢˜ç›®
      let filteredList = []; // ç­›é€‰åé¢˜ç›®
      let curIndex = 0; // ç­›é€‰åç´¢å¼•
      let filterType = "all";
      let userSel = new Set(); // ä¸´æ—¶é€‰æ‹©

      // === åˆå§‹åŒ– ===
      window.onload = async () => {
        try {
          // å°è¯•å¹¶å‘åŠ è½½ä¸¤ä¸ªJSON
          const [res1, res2] = await Promise.allSettled([
            fetch("./questions.json").then((r) => r.json()),
            fetch("./history_questions.json").then((r) => r.json()),
          ]);

          // åŠ è½½å¹¶å°è¯•å‰ç«¯ä¿®å¤ï¼ˆåŒé‡ä¿é™©ï¼Œé˜²æ­¢Pythonæ²¡å¤„ç†å¥½ï¼‰
          modules.postgrad.data = frontendRepair(
            res1.status === "fulfilled" ? res1.value : []
          );
          modules.history.data = frontendRepair(
            res2.status === "fulfilled" ? res2.value : []
          );

          switchModule(curMod);
        } catch (e) {
          console.error(e);
          alert(
            "åŠ è½½å¤±è´¥ï¼šè¯·ç¡®ä¿ä½¿ç”¨ python -m http.server è¿è¡Œï¼Œå¹¶ä¿è¯JSONæ–‡ä»¶å­˜åœ¨ã€‚"
          );
        }
      };

      // å‰ç«¯å…œåº•ä¿®å¤ï¼šå¦‚æœæ£€æµ‹åˆ°æ²¡æœ‰é€‰é¡¹ä½†å†…å®¹é‡ŒåŒ…å«ABCï¼Œå°è¯•åˆ‡å‰²
      function frontendRepair(data) {
        if (!data) return [];
        return data.map((q) => {
          if (q.type === "çŸ¥è¯†ç‚¹") return q;

          // ä¿®å¤é€‰é¡¹ï¼šå¦‚æœæœ‰â€œé€‰â€å­—ï¼Œä¸”optionsä¸ºç©º
          if (q.type.includes("é€‰") && (!q.options || q.options.length === 0)) {
            // æ­£åˆ™å°è¯•æ‹†åˆ†ï¼šA. æˆ– Aã€ æˆ– A(ç©ºæ ¼)
            const parts = q.content.split(/\s(?=[A-E][\.ï¼ã€])/);

            // å¦‚æœåˆ‡åˆ†æˆåŠŸï¼ˆè‡³å°‘åˆ‡å‡ºé¢˜å¹²å’Œ1ä¸ªé€‰é¡¹ï¼‰
            if (parts.length > 1) {
              q.content = parts[0]; // ç¬¬ä¸€æ®µæ˜¯é¢˜å¹²
              q.options = [];
              for (let i = 1; i < parts.length; i++) {
                const t = parts[i].trim();
                q.options.push({
                  label: t.charAt(0),
                  text: t
                    .substring(1)
                    .replace(/^[\.ï¼ã€]/, "")
                    .trim(),
                });
              }
            }
          }
          return q;
        });
      }

      // === æ¨¡å—é€»è¾‘ ===
      function switchModule(key) {
        curMod = key;
        localStorage.setItem("last_mod", key);
        allData = modules[key].data;

        document.getElementById("tab-pg").className =
          key === "postgrad" ? "mod-tab active" : "mod-tab";
        document.getElementById("tab-hist").className =
          key === "history" ? "mod-tab active" : "mod-tab";

        curChapter = "";
        rawList = [];
        filteredList = [];
        initSidebar();

        document.getElementById(
          "qContainer"
        ).innerHTML = `<div style="text-align:center; margin-top:100px; color:#94a3b8;">ğŸ“‚ å·²åˆ‡æ¢è‡³ ${modules[key].name}</div>`;
        document.getElementById("headerTitle").innerText = "è¯·é€‰æ‹©ç« èŠ‚";
        document.getElementById("qJumper").innerHTML = "<option>0/0</option>";
        document.getElementById("qJumper").disabled = true;
      }

      function initSidebar() {
        const list = document.getElementById("chapterList");
        list.innerHTML = "";

        // ç»Ÿè®¡ç« èŠ‚
        const map = new Map();
        allData.forEach((q) => {
          if (!map.has(q.chapter)) map.set(q.chapter, 0);
          map.set(q.chapter, map.get(q.chapter) + 1);
        });

        map.forEach((total, cName) => {
          const key = modules[curMod].prefix + cName;
          const saved = JSON.parse(localStorage.getItem(key) || "[]");
          const done = saved.filter((x) => x && x.done).length;

          const div = document.createElement("div");
          div.className = "chapter-item";
          if (cName === curChapter) div.classList.add("active");
          div.innerHTML = `<span>${cName}</span><span class="badge-pill">${done}/${total}</span>`;
          div.onclick = () => loadChapter(cName);
          list.appendChild(div);
        });
      }

      // === ç« èŠ‚ä¸ç­›é€‰ ===
      function loadChapter(cName) {
        curChapter = cName;
        rawList = allData.filter((q) => q.chapter === cName);

        // æ¢å¤è¿›åº¦
        const key = modules[curMod].prefix + cName;
        const saved = JSON.parse(localStorage.getItem(key) || "[]");
        rawList.forEach((q, i) => {
          if (saved[i]) {
            q.userSel = new Set(saved[i].sel || []);
            q.isSubmitted = saved[i].done || false;
          } else {
            q.userSel = new Set();
            q.isSubmitted = false;
          }
        });

        setFilter(filterType);
        initSidebar();
        if (window.innerWidth <= 768) toggleSidebar();
      }

      function setFilter(type) {
        filterType = type;
        document.querySelectorAll(".filter-chip").forEach((b) => {
          b.className = b.innerText.includes(type === "all" ? "å…¨éƒ¨" : type)
            ? "filter-chip active"
            : "filter-chip";
        });

        if (type === "all") filteredList = rawList;
        else
          filteredList = rawList.filter((q) => q.type && q.type.includes(type));

        // æ›´æ–°è·³è½¬
        const sel = document.getElementById("qJumper");
        sel.innerHTML = "";
        if (filteredList.length === 0) {
          sel.disabled = true;
          document.getElementById(
            "qContainer"
          ).innerHTML = `<div style="text-align:center;margin-top:50px;color:#999">æ²¡æœ‰æ­¤ç±»é¢˜ç›®</div>`;
          return;
        }

        sel.disabled = false;
        filteredList.forEach((q, i) => {
          sel.add(
            new Option(
              `${i + 1}. ${shorten(q.content)} ${q.isSubmitted ? "âœ…" : ""}`,
              i
            )
          );
        });

        // æ‰¾ç¬¬ä¸€ä¸ªæœªåš
        let next = filteredList.findIndex((q) => !q.isSubmitted);
        curIndex = next === -1 ? 0 : next;
        renderQ();
      }

      function shorten(s) {
        return s.length > 8 ? s.substring(0, 8) + "..." : s;
      }

      // === æ¸²æŸ“æ ¸å¿ƒ ===
      function renderQ() {
        if (!filteredList.length) return;
        const q = filteredList[curIndex];

        document.getElementById("headerTitle").innerText = curChapter;
        document.getElementById("qJumper").value = curIndex;
        userSel = new Set(q.userSel);

        const container = document.getElementById("qContainer");

        // æ ¹æ®ç±»å‹å†³å®šå¡ç‰‡æ ·å¼
        let cardClass = "card";
        let btnText = "âœ… æäº¤ç­”æ¡ˆ";
        let btnClass = "btn btn-primary";

        if (q.type === "çŸ¥è¯†ç‚¹") {
          cardClass += " knowledge-mode";
          btnText = q.isSubmitted ? "å·²èƒŒç†Ÿ" : "ğŸ‘Œ è®°ä½äº†";
          btnClass = "btn btn-knowledge";
        } else if (q.type === "ææ–™é¢˜") {
          cardClass += " material-mode";
        }

        if (q.isSubmitted && q.type !== "çŸ¥è¯†ç‚¹") {
          btnText =
            curIndex < filteredList.length - 1 ? "ä¸‹ä¸€é¢˜ â¡ï¸" : "å®Œæˆæœ¬ç« ";
        }

        // æ›´æ–°ä¸»æŒ‰é’®
        const mBtn = document.getElementById("mainBtn");
        mBtn.innerText = btnText;
        mBtn.className = btnClass;

        // æ¸²æŸ“é€‰é¡¹æˆ–å†…å®¹
        let bodyHtml = "";

        if (q.type === "çŸ¥è¯†ç‚¹") {
          bodyHtml = `<div style="font-size:1.1rem; line-height:1.8; color:#b45309;">${q.content}</div>`;
        } else if (q.options && q.options.length > 0) {
          bodyHtml = `<div class="opts-container">
              ${q.options
                .map((opt) => {
                  let cls = "opt-row";
                  if (q.isSubmitted) {
                    const ans = (q.answer || "").toUpperCase();
                    if (ans.includes(opt.label)) cls += " correct";
                    else if (userSel.has(opt.label)) cls += " wrong";
                  } else {
                    if (userSel.has(opt.label)) cls += " selected";
                  }
                  return `
                 <div class="${cls}" onclick="handleOpt('${opt.label}')">
                   <div class="opt-idx">${opt.label}</div>
                   <div style="flex:1">${opt.text}</div>
                 </div>`;
                })
                .join("")}
            </div>`;
        } else if (q.type === "ææ–™é¢˜" || q.type === "ç®€ç­”é¢˜") {
          bodyHtml = `<div style="padding:15px; background:#f1f5f9; border-radius:8px; color:#64748b; font-style:italic">
              (è¯·åœ¨å¿ƒä¸­ä½œç­”ï¼Œç„¶åç‚¹å‡»æäº¤æŸ¥çœ‹å‚è€ƒç­”æ¡ˆ)
            </div>`;
        } else {
          bodyHtml = `<div style="color:red">æ— æ³•è¯†åˆ«é€‰é¡¹ï¼Œè¯·æŸ¥çœ‹ç­”æ¡ˆã€‚</div>`;
        }

        container.innerHTML = `
          <div class="${cardClass}">
             <div class="q-header">
                <span class="q-type">${q.type || "é¢˜ç›®"}</span>
                <span style="font-size:0.8rem; color:#94a3b8">${
                  curIndex + 1
                } / ${filteredList.length}</span>
             </div>
             ${
               q.type !== "çŸ¥è¯†ç‚¹"
                 ? `<div class="q-content">${q.content}</div>`
                 : ""
             }
             ${bodyHtml}
             
             <div class="answer-section ${
               q.isSubmitted ? "show" : ""
             }" id="ansPanel">
                <div style="margin-bottom:10px;">
                   <span style="font-weight:bold; color:#1e293b">å‚è€ƒç­”æ¡ˆï¼š</span>
                   <span style="color:var(--primary); font-weight:bold; font-size:1.1rem">${
                     q.answer || "ç•¥"
                   }</span>
                </div>
                <div style="font-size:0.95rem; color:#475569; border-top:1px solid #e2e8f0; padding-top:10px; line-height:1.6">
                   <strong>è§£æï¼š</strong><br>${q.explanation || "æš‚æ— "}
                </div>
             </div>
          </div>
        `;
      }

      // === äº¤äº’ ===
      window.handleOpt = function (label) {
        const q = filteredList[curIndex];
        if (q.isSubmitted) return;

        const isMulti =
          (q.type && q.type.includes("å¤š")) ||
          (q.answer && q.answer.length > 1);
        if (isMulti) {
          if (userSel.has(label)) userSel.delete(label);
          else userSel.add(label);
        } else {
          userSel.clear();
          userSel.add(label);
        }
        q.userSel = new Set(userSel);
        renderQ();
      };

      window.handleMainAction = function () {
        const q = filteredList[curIndex];
        if (q.isSubmitted) {
          move(1);
        } else {
          q.isSubmitted = true;
          saveProgress();
          renderQ();
          initSidebar(); // æ›´æ–°è¿›åº¦
          // æ›´æ–°ä¸‹æ‹‰æ¡†æ ‡è®°
          const sel = document.getElementById("qJumper");
          if (sel.options[curIndex]) sel.options[curIndex].text += " âœ…";
        }
      };

      window.move = function (dir) {
        const next = curIndex + dir;
        if (next >= 0 && next < filteredList.length) {
          curIndex = next;
          renderQ();
        } else {
          if (dir === 1) alert("æœ¬ç±»é¢˜ç›®å·²ç»“æŸ");
        }
      };

      window.jumpTo = function (v) {
        curIndex = parseInt(v);
        renderQ();
      };

      window.toggleAns = function () {
        const p = document.getElementById("ansPanel");
        if (p) p.classList.toggle("show");
      };

      window.resetChapter = function () {
        if (!confirm(`æ¸…ç©ºã€${curChapter}ã€‘è¿›åº¦ï¼Ÿ`)) return;
        rawList.forEach((q) => {
          q.isSubmitted = false;
          q.userSel = new Set();
        });
        saveProgress();
        loadChapter(curChapter);
      };

      function saveProgress() {
        const state = rawList.map((q) => ({
          sel: Array.from(q.userSel),
          done: q.isSubmitted,
        }));
        localStorage.setItem(
          modules[curMod].prefix + curChapter,
          JSON.stringify(state)
        );
      }

      window.toggleSidebar = function () {
        document.getElementById("sidebar").classList.toggle("open");
        document.getElementById("overlay").classList.toggle("active");
      };
    </script>
  </body>
</html>
