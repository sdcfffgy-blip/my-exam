<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>ËøëÁé∞‰ª£Âè≤Âà∑È¢ò - ÊåÅ‰πÖÂåñËá™ÈÄÇÂ∫îÁâà</title>
    <style>
      :root {
        --primary: #2563eb;
        --primary-light: #eff6ff;
        --success: #10b981;
        --success-bg: #ecfdf5;
        --error: #ef4444;
        --error-bg: #fef2f2;
        --text-main: #1f2937;
        --bg-color: #f3f4f6;
        --sidebar-width: 280px;
      }

      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif;
        background-color: var(--bg-color);
        color: var(--text-main);
        height: 100vh;
        display: flex;
        overflow: hidden;
      }

      /* === ‰æßËæπÊ†è === */
      .sidebar {
        width: var(--sidebar-width);
        background: white;
        border-right: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        transition: transform 0.3s ease;
        z-index: 1000;
      }

      .sidebar-header {
        padding: 20px;
        font-size: 1.1rem;
        font-weight: bold;
        color: var(--primary);
        border-bottom: 1px solid #f3f4f6;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .chapter-container {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
      }
      .chap-title {
        font-weight: bold;
        padding: 12px 10px;
        margin-top: 10px;
        color: #111;
        background: #f9fafb;
        border-radius: 8px;
        font-size: 0.9rem;
      }
      .type-item {
        padding: 12px 15px;
        margin: 4px 0;
        border-radius: 8px;
        cursor: pointer;
        color: #4b5563;
        font-size: 0.85rem;
        display: flex;
        justify-content: space-between;
      }
      .type-item.selected {
        background: var(--primary);
        color: white;
      }

      /* === ‰∏ªÂå∫Âüü === */
      .main-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        position: relative;
        min-width: 0;
      }
      .mobile-nav {
        display: none;
        height: 56px;
        background: white;
        border-bottom: 1px solid #e5e7eb;
        padding: 0 15px;
        align-items: center;
        justify-content: space-between;
      }
      .scroll-content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        justify-content: center;
      }
      .card {
        background: white;
        width: 100%;
        max-width: 800px;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        height: fit-content;
      }

      .meta-info {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }
      .badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: bold;
        font-size: 11px;
      }
      .badge-chap {
        background: var(--primary-light);
        color: var(--primary);
      }
      .badge-type {
        background: #f3e8ff;
        color: #7e22ce;
      }
      .res-indicator {
        margin-left: auto;
        font-weight: bold;
        font-size: 14px;
      }

      .q-text {
        font-size: 1.1rem;
        line-height: 1.6;
        margin-bottom: 25px;
        color: #111;
        white-space: pre-wrap;
      }
      .options-list {
        display: grid;
        gap: 12px;
      }

      .option-item {
        display: flex;
        align-items: flex-start;
        padding: 16px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        cursor: pointer;
        transition: 0.2s;
        background: white;
      }
      .option-item.selected {
        border-color: var(--primary);
        background: var(--primary-light);
      }
      .option-item.correct {
        border-color: var(--success);
        background: var(--success-bg);
      }
      .option-item.wrong {
        border-color: var(--error);
        background: var(--error-bg);
      }

      .opt-label {
        font-size: 1.1rem;
        font-weight: bold;
        width: 28px;
        flex-shrink: 0;
        color: #6b7280;
      }
      .opt-content {
        font-size: 1rem;
        line-height: 1.5;
        color: #374151;
      }

      .footer-bar {
        height: 72px;
        background: white;
        border-top: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 0 10px;
      }
      .btn {
        height: 44px;
        padding: 0 15px;
        border-radius: 22px;
        border: 1px solid #d1d5db;
        background: white;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
      }
      .btn-primary {
        background: var(--primary);
        color: white;
        border: none;
      }
      .btn-reset {
        border-color: var(--error);
        color: var(--error);
      }

      .analysis-box {
        margin-top: 20px;
        padding: 15px;
        background: #f8fafc;
        border-left: 4px solid var(--primary);
        display: none;
        border-radius: 8px;
      }
      .analysis-box.show {
        display: block;
      }
      .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }

      @media (max-width: 768px) {
        .sidebar {
          position: fixed;
          height: 100%;
          transform: translateX(-100%);
        }
        .sidebar.active {
          transform: translateX(0);
        }
        .mobile-nav {
          display: flex;
        }
        .overlay.active {
          display: block;
        }
      }
    </style>
  </head>
  <body>
    <div class="overlay" id="overlay"></div>

    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <span>Á´†ËäÇÁõÆÂΩï</span>
        <button
          onclick="toggleSidebar()"
          id="close-sidebar"
          style="display: none; background: none; border: none; font-size: 24px"
        >
          √ó
        </button>
      </div>
      <div class="chapter-container" id="chap-list"></div>
      <div style="padding: 15px; border-top: 1px solid #eee">
        <button
          class="btn btn-reset"
          style="width: 100%"
          onclick="resetCurrentChapter()"
        >
          üîÑ ÈáçÁΩÆÂΩìÂâçÁ´†ËäÇ
        </button>
      </div>
    </div>

    <div class="main-area">
      <div class="mobile-nav">
        <button
          onclick="toggleSidebar()"
          class="btn"
          style="height: 34px; padding: 0 10px"
        >
          ‚ò∞ ÁõÆÂΩï
        </button>
        <span id="mobile-title" style="font-size: 14px; font-weight: bold"
          >Âà∑È¢òÊ®°Âºè</span
        >
      </div>

      <div class="scroll-content">
        <div class="card">
          <div class="meta-info">
            <span class="badge badge-chap" id="q-chap">ËΩΩÂÖ•‰∏≠</span>
            <span class="badge badge-type" id="q-type">ËΩΩÂÖ•‰∏≠</span>
            <span id="res-status" class="res-indicator"></span>
          </div>
          <div class="q-text" id="q-content">Ê≠£Âú®ËΩΩÂÖ•Êï∞ÊçÆ...</div>
          <div class="options-list" id="options-area"></div>
          <div
            id="action-area"
            style="text-align: center; margin-top: 25px"
          ></div>
          <div class="analysis-box" id="analysis">
            <h4 style="margin: 0 0 10px 0; color: var(--success)">
              Ê≠£Á°ÆÁ≠îÊ°àÔºö<span id="true-ans"></span>
            </h4>
            <div
              id="explanation"
              style="line-height: 1.6; font-size: 14px; color: #4b5563"
            ></div>
          </div>
        </div>
      </div>

      <div class="footer-bar">
        <button class="btn" onclick="changeQ(-1)">‰∏ä‰∏ÄÈ¢ò</button>
        <span
          id="progress-txt"
          style="
            font-size: 13px;
            color: #6b7280;
            min-width: 45px;
            text-align: center;
          "
          >0/0</span
        >
        <button class="btn" onclick="changeQ(1)">‰∏ã‰∏ÄÈ¢ò</button>
      </div>
    </div>

    <script>
      let allData = [],
        currentList = [],
        currentChapterName = "";
      let currentIndex = 0,
        userSel = new Set(),
        answered = false;

      window.onload = () => {
        fetch("questions.json")
          .then((res) => res.json())
          .then((data) => {
            allData = data.map((q, index) => ({
              ...q,
              id: index,
              historySel: [], // Â≠òÂÇ®ÂéÜÂè≤ÈÄâÊã©
              isSubmitted: false, // Â≠òÂÇ®Êèê‰∫§Áä∂ÊÄÅ
            }));
            initSidebar();
            const first = document.querySelector(".type-item");
            if (first) first.click();
          });
      };

      function toggleSidebar() {
        document.getElementById("sidebar").classList.toggle("active");
        document.getElementById("overlay").classList.toggle("active");
      }

      document.getElementById("overlay").onclick = toggleSidebar;

      function initSidebar() {
        const container = document.getElementById("chap-list");
        const chaps = [...new Set(allData.map((q) => q.chapter))].sort(
          (a, b) => parseInt(a.match(/\d+/)) - parseInt(b.match(/\d+/))
        );
        chaps.forEach((chap) => {
          const title = document.createElement("div");
          title.className = "chap-title";
          title.innerText = chap;
          container.appendChild(title);

          const chapQs = allData.filter((q) => q.chapter === chap);
          const types = [...new Set(chapQs.map((q) => q.type))];
          types.forEach((type) => {
            const count = chapQs.filter((q) => q.type === type).length;
            const item = document.createElement("div");
            item.className = "type-item";
            item.innerHTML = `<span>${type}</span> <span style="opacity:0.5">${count}</span>`;
            item.onclick = () => {
              document
                .querySelectorAll(".type-item")
                .forEach((i) => i.classList.remove("selected"));
              item.classList.add("selected");
              if (window.innerWidth <= 768) toggleSidebar();
              currentChapterName = chap;
              currentList = allData.filter(
                (q) => q.chapter === chap && q.type === type
              );
              currentIndex = 0;
              renderQ();
            };
            container.appendChild(item);
          });
        });
      }

      function renderQ() {
        const q = currentList[currentIndex];
        // === ÊåÅ‰πÖÂåñÊ†∏ÂøÉÔºö‰ªéÂØπË±°‰∏≠ÊÅ¢Â§çÁä∂ÊÄÅ ===
        userSel = new Set(q.historySel || []);
        answered = q.isSubmitted || false;

        document.getElementById("q-chap").innerText = q.chapter;
        document.getElementById("q-type").innerText = q.type;
        document.getElementById("progress-txt").innerText = `${
          currentIndex + 1
        }/${currentList.length}`;
        document.getElementById("q-content").innerText = q.content;
        document.getElementById("true-ans").innerText = q.answer;
        document.getElementById("explanation").innerText =
          q.explanation || "ÊöÇÊó†Ëß£Êûê";
        document.getElementById("res-status").innerText = "";
        document.getElementById("analysis").classList.remove("show");

        const optArea = document.getElementById("options-area");
        const actArea = document.getElementById("action-area");
        optArea.innerHTML = "";
        actArea.innerHTML = "";

        if (q.type.includes("ÈÄâ")) {
          q.options.forEach((opt) => {
            const el = document.createElement("div");
            el.className =
              "option-item" + (userSel.has(opt.label) ? " selected" : "");
            el.dataset.label = opt.label;
            el.innerHTML = `<div class="opt-label">${opt.label}</div><div class="opt-content">${opt.text}</div>`;
            el.onclick = () => handleOptClick(el, opt.label);
            optArea.appendChild(el);
          });
          if (q.type === "Â§öÈÄâÈ¢ò") {
            actArea.innerHTML = `<button class="btn btn-primary" style="width:100%" onclick="submitMulti()">Á°ÆËÆ§Êèê‰∫§</button>`;
          }
        } else {
          actArea.innerHTML = `<button class="btn btn-primary" style="width:100%" onclick="showAns()">Êü•ÁúãÁ≠îÊ°à</button>`;
        }

        // Â¶ÇÊûúËØ•È¢òÂ∑≤ÁªèÊèê‰∫§ËøáÔºåÁ´ãÂç≥ÊòæÁ§∫Âà§ÂÆöÁªìÊûú
        if (answered) {
          const finalAns = Array.from(userSel).sort().join("");
          checkAns(finalAns, false);
        }
      }

      function handleOptClick(el, label) {
        const q = currentList[currentIndex];
        if (answered && q.type !== "Â§öÈÄâÈ¢ò") return;
        if (q.type === "ÂçïÈÄâÈ¢ò") {
          checkAns(label, true);
        } else {
          if (userSel.has(label)) {
            userSel.delete(label);
            el.classList.remove("selected");
          } else {
            userSel.add(label);
            el.classList.add("selected");
          }
        }
      }

      function submitMulti() {
        if (answered) return;
        const userAns = Array.from(userSel).sort().join("");
        if (!userAns) return alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™ÈÄâÈ°π");
        checkAns(userAns, true);
      }

      function checkAns(userAns, shouldSave) {
        const q = currentList[currentIndex];
        const correctStr = q.answer
          .replace(/[^A-D]/g, "")
          .split("")
          .sort()
          .join("");

        // ‰øùÂ≠òÁä∂ÊÄÅÂà∞Êï∞ÊçÆÂØπË±°
        if (shouldSave) {
          answered = true;
          q.isSubmitted = true;
          q.historySel = Array.from(userSel);
        }

        const status = document.getElementById("res-status");
        if (userAns === correctStr) {
          status.innerText = "‚úì Ê≠£Á°Æ";
          status.style.color = "var(--success)";
        } else {
          status.innerText = "‚úï ÈîôËØØ";
          status.style.color = "var(--error)";
        }

        document.getElementById("analysis").classList.add("show");
        document.querySelectorAll(".option-item").forEach((el) => {
          const lbl = el.dataset.label;
          if (correctStr.includes(lbl)) el.classList.add("correct");
          else if (userAns.includes(lbl)) el.classList.add("wrong");
        });
      }

      // === Á´†ËäÇÈáçÁΩÆÂáΩÊï∞ ===
      function resetCurrentChapter() {
        if (!currentChapterName) return;
        if (confirm(`Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫‚Äú${currentChapterName}‚ÄùÁöÑÊâÄÊúâÂà∑È¢òËÆ∞ÂΩïÂêóÔºü`)) {
          allData.forEach((q) => {
            if (q.chapter === currentChapterName) {
              q.historySel = [];
              q.isSubmitted = false;
            }
          });
          renderQ();
        }
      }

      function showAns() {
        const q = currentList[currentIndex];
        q.isSubmitted = true;
        document.getElementById("analysis").classList.add("show");
      }

      function changeQ(dir) {
        const next = currentIndex + dir;
        if (next >= 0 && next < currentList.length) {
          currentIndex = next;
          renderQ();
        }
      }
    </script>
  </body>
</html>
